#!/bin/tcsh
#PBS -l ncpus=4
#PBS -l mem=8gb
#PBS -l walltime=00:15:00
#PBS -q workq@e5-cse-cbgpu01.eecscl.psu.edu
#PBS -N loop_test
#PBS -M pxm5426@psu.edu
#PBS -m bea
#PBS -o pbs_results/
#PBS -e pbs_results/

# Quick Test: Loop Detection Analysis
# Small sample (100 rows) with 4 workers to verify everything works

cd $PBS_O_WORKDIR

if ( -f ~/.tcshrc ) source ~/.tcshrc

# Environment setup
setenv UV_CACHE_DIR /scratch/pxm5426/.cache/uv
setenv HF_HOME /scratch/pxm5426/work/hf_cache
setenv PYTHONUNBUFFERED 1
setenv TOKENIZERS_PARALLELISM false

# Create directories
mkdir -p logs pbs_results

set LOG_FILE = "logs/loop_test_$PBS_JOBID.log"

echo "============================================" |& tee $LOG_FILE
echo "Loop Analysis TEST Job Started: `date`" |& tee -a $LOG_FILE
echo "Working directory: $PBS_O_WORKDIR" |& tee -a $LOG_FILE
echo "CPUs allocated: 4" |& tee -a $LOG_FILE
echo "Sample size: 100" |& tee -a $LOG_FILE
echo "============================================" |& tee -a $LOG_FILE

# Test with small sample
set DATASET = "pmahdavi/livecodebench-merging-leaderboard"
set OUTPUT = "loop_analysis_test_results.json"

echo "Dataset: $DATASET" |& tee -a $LOG_FILE
echo "Output: $OUTPUT" |& tee -a $LOG_FILE
echo "" |& tee -a $LOG_FILE

# Install with hub extra for datasets library
uv sync --extra hub

uv run python analyze_loops.py \
    --dataset "$DATASET" \
    --sample 100 \
    --workers 4 \
    --batch-size 25 \
    --output "$OUTPUT" \
    |& tee -a $LOG_FILE

set exit_status = $status

echo "" |& tee -a $LOG_FILE
echo "============================================" |& tee -a $LOG_FILE
echo "Test Job Completed: `date`" |& tee -a $LOG_FILE
echo "Exit status: $exit_status" |& tee -a $LOG_FILE
echo "============================================" |& tee -a $LOG_FILE

exit $exit_status
